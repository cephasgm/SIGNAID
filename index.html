<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGNAID - Sign Language Communication Bridge</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2563eb">
  
  <!-- Three.js for 3D Avatars -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- MediaPipe for Hand Tracking -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    body {
      background: linear-gradient(145deg, #0a0f1f 0%, #1a2639 100%);
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 30%, rgba(37, 99, 235, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(124, 58, 237, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 40% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 40%);
      pointer-events: none;
      z-index: 0;
    }

    #app {
      max-width: 1600px;
      margin: 0 auto;
      padding: 15px;
      position: relative;
      z-index: 1;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Professional Navbar */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 25px;
      background: rgba(10, 15, 30, 0.7);
      backdrop-filter: blur(12px);
      border-radius: 50px;
      margin-bottom: 15px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
    }

    .logo-text {
      font-size: 1.8rem;
      font-weight: 600;
      background: linear-gradient(135deg, #fff, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
    }

    .logo-text span {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .nav-buttons {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 24px;
      border-radius: 40px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
      letter-spacing: 0.3px;
    }

    .btn-outline {
      background: transparent;
      border: 1.5px solid rgba(255, 255, 255, 0.15);
      color: white;
    }

    .btn-outline:hover {
      border-color: #2563eb;
      background: rgba(37, 99, 235, 0.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: white;
      box-shadow: 0 8px 20px -5px #2563eb;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px -5px #2563eb;
    }

    /* Main Layout - Optimized space */
    .main-grid {
      display: grid;
      grid-template-columns: 1.3fr 0.7fr;
      gap: 15px;
      height: calc(100vh - 90px);
    }

    /* 3D Avatar Panel - Professional */
    .avatar-panel {
      background: rgba(10, 15, 30, 0.6);
      backdrop-filter: blur(12px);
      border-radius: 35px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    #avatarCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #handCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 5;
    }

    .caption-overlay {
      position: absolute;
      bottom: 25px;
      left: 25px;
      right: 25px;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(16px);
      padding: 18px 25px;
      border-radius: 40px;
      color: white;
      font-size: 1.5rem;
      font-weight: 500;
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 10;
      text-align: center;
    }

    /* Control Panel - Compact & Professional */
    .control-panel {
      background: rgba(10, 15, 30, 0.7);
      backdrop-filter: blur(16px);
      border-radius: 35px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow-y: auto;
    }

    /* Language Selectors - Compact */
    .language-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 25px;
      padding: 15px;
    }

    .lang-selector {
      flex: 1;
    }

    .lang-label {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #94a3b8;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .lang-select {
      width: 100%;
      padding: 12px 15px;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 15px;
    }

    .lang-select option {
      background: #1a2639;
      color: white;
    }

    /* Mode Tabs - Professional */
    .mode-tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      background: rgba(0, 0, 0, 0.25);
      padding: 6px;
      border-radius: 40px;
    }

    .mode-tab {
      padding: 14px;
      border-radius: 34px;
      border: none;
      background: transparent;
      color: #94a3b8;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .mode-tab.active {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: white;
      box-shadow: 0 8px 20px -5px #2563eb;
    }

    /* Output Area - Clean */
    .output-area {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 25px;
      padding: 20px;
      min-height: 100px;
    }

    #outputPhrase {
      font-size: 1.4rem;
      color: #e2e8f0;
      margin-bottom: 5px;
      font-weight: 500;
      word-break: break-word;
    }

    #outputSign {
      font-size: 1.8rem;
      color: #2563eb;
      font-weight: 600;
      margin-bottom: 8px;
    }

    #statusMessage {
      color: #64748b;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Action Buttons - Clean */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .action-btn {
      padding: 16px;
      border-radius: 35px;
      border: none;
      background: rgba(255, 255, 255, 0.03);
      color: white;
      font-size: 1rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .action-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px #2563eb;
    }

    .action-btn.active {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
    }

    .action-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Status Panel - Compact */
    .status-panel {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 25px;
      padding: 12px;
    }

    .status-item {
      text-align: center;
    }

    .status-label {
      color: #64748b;
      font-size: 0.7rem;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .status-value {
      color: white;
      font-size: 0.8rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .dot.active { background: #10b981; box-shadow: 0 0 10px #10b981; }
    .dot.inactive { background: #ef4444; }
    .dot.ready { background: #2563eb; }

    /* Professional Welcome Banner */
    .welcome-banner {
      position: fixed;
      top: 80px;
      right: 30px;
      background: rgba(37, 99, 235, 0.9);
      backdrop-filter: blur(10px);
      padding: 12px 25px;
      border-radius: 40px;
      color: white;
      font-size: 0.95rem;
      z-index: 100;
      animation: slideIn 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 10px 30px -5px #2563eb;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      to { opacity: 0; transform: translateX(100%); }
    }

    /* Error Console */
    .error-console {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      color: #f87171;
      padding: 12px 20px;
      border-radius: 30px;
      font-family: monospace;
      font-size: 0.85rem;
      z-index: 1000;
      display: none;
      border: 1px solid #ef4444;
    }

    .error-console.show { display: block; }

    /* Auth Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(16px);
      align-items: center; justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: rgba(15, 23, 42, 0.9);
      padding: 35px;
      border-radius: 45px;
      width: 400px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-content h2 {
      color: white;
      margin-bottom: 25px;
      text-align: center;
      font-size: 1.8rem;
    }

    .modal-content input {
      width: 100%;
      padding: 14px 20px;
      margin-bottom: 15px;
      border-radius: 35px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-footer {
      margin-top: 20px;
      color: #64748b;
      text-align: center;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .modal-footer:hover { color: #2563eb; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="logo">
        <div class="logo-icon">ü§ü</div>
        <div class="logo-text">SIGN<span>AID</span></div>
      </div>
      <div class="nav-buttons">
        <button class="btn btn-outline" id="loginBtn">Login</button>
        <button class="btn btn-primary" id="signupBtn">Sign Up</button>
        <button class="btn btn-outline" id="logoutBtn" style="display: none;">Logout</button>
      </div>
    </nav>

    <!-- Welcome Banner (auto-disappears) -->
    <div class="welcome-banner" id="welcomeBanner" style="display: none;"></div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Avatar Panel -->
      <div class="avatar-panel">
        <canvas id="avatarCanvas"></canvas>
        <canvas id="handCanvas"></canvas>
        <div class="caption-overlay" id="liveCaption">ü§ü Ready to assist</div>
      </div>

      <!-- Control Panel -->
      <div class="control-panel">
        <!-- Language Row - Compact -->
        <div class="language-row">
          <div class="lang-selector">
            <div class="lang-label">üó£Ô∏è SPEAKING</div>
            <select class="lang-select" id="spokenLang">
              <option value="sw">Swahili</option>
              <option value="en" selected>English</option>
              <option value="es">Espa√±ol</option>
              <option value="fr">Fran√ßais</option>
              <option value="de">Deutsch</option>
              <option value="zh">‰∏≠Êñá</option>
              <option value="ja">Êó•Êú¨Ë™û</option>
              <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
              <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
              <option value="ru">–†—É—Å—Å–∫–∏–π</option>
              <option value="pt">Portugu√™s</option>
              <option value="it">Italiano</option>
            </select>
          </div>
          <div class="lang-selector">
            <div class="lang-label">ü§ü SIGNING</div>
            <select class="lang-select" id="signLang">
              <option value="ASL">ASL (American)</option>
              <option value="BSL">BSL (British)</option>
              <option value="Swahili Sign" selected>Swahili Sign</option>
              <option value="LSF">LSF (French)</option>
              <option value="DGS">DGS (German)</option>
              <option value="CSL">CSL (Chinese)</option>
              <option value="JSL">JSL (Japanese)</option>
              <option value="ArSL">ArSL (Arabic)</option>
              <option value="Indian Sign">Indian Sign</option>
            </select>
          </div>
        </div>

        <!-- Mode Tabs -->
        <div class="mode-tabs">
          <button class="mode-tab active" id="modeSign2Speech">
            ‚úã SIGN ‚Üí üó£Ô∏è SPEECH
          </button>
          <button class="mode-tab" id="modeSpeech2Sign">
            üé§ SPEECH ‚Üí ‚úã SIGN
          </button>
        </div>

        <!-- Output Area - Shows communication flow -->
        <div class="output-area">
          <div id="outputPhrase">Ready to communicate</div>
          <div id="outputSign"></div>
          <div id="statusMessage">‚ö° Waiting for input...</div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="action-btn" id="cameraBtn" disabled>
            üì∑ Start Camera
          </button>
          <button class="action-btn" id="micBtn" disabled>
            üé§ Start Mic
          </button>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
          <div class="status-item">
            <div class="status-label">CAMERA</div>
            <div class="status-value" id="cameraStatus"><span class="dot inactive"></span> Off</div>
          </div>
          <div class="status-item">
            <div class="status-label">MIC</div>
            <div class="status-value" id="micStatus"><span class="dot inactive"></span> Off</div>
          </div>
          <div class="status-item">
            <div class="status-label">MODE</div>
            <div class="status-value" id="modeStatus">‚úã‚Üíüó£Ô∏è</div>
          </div>
          <div class="status-item">
            <div class="status-label">LIVE</div>
            <div class="status-value" id="liveStatus"><span class="dot ready"></span> Ready</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Console -->
  <div class="error-console" id="errorConsole"></div>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <h2 id="modalTitle">Login</h2>
      <input type="email" id="authEmail" placeholder="Email">
      <input type="password" id="authPassword" placeholder="Password">
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-outline" id="modalCancel" style="flex:1">Cancel</button>
        <button class="btn btn-primary" id="modalConfirm" style="flex:1">Continue</button>
      </div>
      <div class="modal-footer" id="modalToggle">Don't have an account? Sign up</div>
    </div>
  </div>

  <script>
    // ========== FIREBASE CONFIG ==========
    const firebaseConfig = {
      apiKey: "AIzaSyBsewmLbx9LzzlhC-xzm8KPN9g-2zZFa0M",
      authDomain: "signaid-app.firebaseapp.com",
      projectId: "signaid-app",
      storageBucket: "signaid-app.firebasestorage.app",
      messagingSenderId: "520796391275",
      appId: "1:520796391275:web:748273f6d18765190bae2e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ========== GLOBAL VARIABLES ==========
    let currentUser = null;
    let currentMode = 'sign2speech';
    let cameraActive = false;
    let micActive = false;
    let videoStream = null;
    let recognition = null;
    let scene, camera3D, renderer, avatar;

    // ========== PROFESSIONAL WELCOME HANDLER ==========
    function showWelcome(email) {
      const banner = document.getElementById('welcomeBanner');
      banner.innerHTML = `üëã Welcome${email ? ' ' + email.split('@')[0] : ''}`;
      banner.style.display = 'block';
      
      // Auto disappear after 3 seconds
      setTimeout(() => {
        banner.style.display = 'none';
      }, 3000);
    }

    // ========== ERROR HANDLING ==========
    const errorConsole = document.getElementById('errorConsole');
    
    function logError(message, error = null) {
      const timestamp = new Date().toLocaleTimeString();
      const errorMsg = `[${timestamp}] ${message} ${error ? error.message : ''}`;
      console.error(errorMsg);
      errorConsole.innerHTML += errorMsg + '<br>';
      errorConsole.classList.add('show');
      setTimeout(() => errorConsole.classList.remove('show'), 5000);
    }

    function logInfo(message) {
      console.log(`[${timestamp}] ${message}`);
    }

    // ========== 3D AVATAR SETUP ==========
    function init3DAvatar() {
      try {
        const canvas = document.getElementById('avatarCanvas');
        
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0f1f);
        
        camera3D = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera3D.position.set(0, 1.5, 5);
        
        renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.shadowMap.enabled = true;
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);
        
        const mainLight = new THREE.DirectionalLight(0xffffff, 1);
        mainLight.position.set(2, 5, 5);
        mainLight.castShadow = true;
        scene.add(mainLight);
        
        createAvatar();
        animate();
      } catch (error) {
        logError('3D initialization failed:', error);
      }
    }

    function createAvatar() {
      // Body
      const bodyGeo = new THREE.CylinderGeometry(0.6, 0.7, 1.8, 32);
      const bodyMat = new THREE.MeshPhongMaterial({ color: 0x2a6b9e });
      const body = new THREE.Mesh(bodyGeo, bodyMat);
      body.position.y = 0.9;
      body.castShadow = true;
      scene.add(body);
      
      // Head
      const headGeo = new THREE.SphereGeometry(0.5, 32);
      const headMat = new THREE.MeshPhongMaterial({ color: 0xffccaa });
      const head = new THREE.Mesh(headGeo, headMat);
      head.position.y = 2.0;
      head.castShadow = true;
      scene.add(head);
      
      // Arms
      const armGeo = new THREE.CylinderGeometry(0.15, 0.15, 1.2);
      const armMat = new THREE.MeshPhongMaterial({ color: 0x2a6b9e });
      
      const leftArm = new THREE.Mesh(armGeo, armMat);
      leftArm.position.set(-0.8, 1.5, 0);
      scene.add(leftArm);
      
      const rightArm = new THREE.Mesh(armGeo, armMat);
      rightArm.position.set(0.8, 1.5, 0);
      scene.add(rightArm);
      
      // Hands
      const handGeo = new THREE.SphereGeometry(0.2, 16);
      const handMat = new THREE.MeshPhongMaterial({ color: 0xffccaa });
      
      const leftHand = new THREE.Mesh(handGeo, handMat);
      leftHand.position.set(-1.3, 1.0, 0);
      scene.add(leftHand);
      
      const rightHand = new THREE.Mesh(handGeo, handMat);
      rightHand.position.set(1.3, 1.0, 0);
      scene.add(rightHand);
      
      avatar = { head, leftArm, rightArm, leftHand, rightHand };
    }

    function animate() {
      requestAnimationFrame(animate);
      
      if (avatar && renderer && scene && camera3D) {
        const time = Date.now() * 0.002;
        
        // Universal sign language animation
        avatar.leftArm.rotation.x = Math.sin(time) * 0.3;
        avatar.rightArm.rotation.x = Math.cos(time) * 0.3;
        avatar.leftHand.position.y = 1.0 + Math.sin(time * 2) * 0.1;
        avatar.rightHand.position.y = 1.0 + Math.cos(time * 2) * 0.1;
        
        renderer.render(scene, camera3D);
      }
    }

    // ========== UNIVERSAL SIGN LANGUAGE DATABASE ==========
    const signDatabase = {
      // Common phrases in all languages
      'hello': {
        'ASL': 'üëã (wave hand)',
        'BSL': 'ü§ö (open hand)',
        'Swahili Sign': 'ü§ù (handshake motion)',
        'LSF': '‚úã (raised hand)',
        'DGS': 'üñêÔ∏è (open palm)'
      },
      'thank you': {
        'ASL': 'üëç (thumb to chin)',
        'BSL': 'üëå (hand to mouth)',
        'Swahili Sign': 'üôè (hands together)',
        'LSF': 'ü§û (two fingers)',
        'DGS': 'üëè (clap gesture)'
      },
      'help': {
        'ASL': 'üÜò (fist on palm)',
        'BSL': 'ü§≤ (open hands)',
        'Swahili Sign': 'üÜò (crossed arms)',
        'LSF': 'üÜò (hand up)',
        'DGS': 'üÜò (two hands)'
      },
      'how are you': {
        'ASL': 'üëÜ (point then circle)',
        'BSL': 'ü§∑ (shrug)',
        'Swahili Sign': 'ü´Ç (hug gesture)',
        'LSF': 'ü§î (thinking)',
        'DGS': 'üëê (open hands)'
      }
    };

    // ========== MODE CONTROL ==========
    document.getElementById('modeSign2Speech').addEventListener('click', function() {
      document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      currentMode = 'sign2speech';
      document.getElementById('modeStatus').innerHTML = '‚úã‚Üíüó£Ô∏è';
      document.getElementById('outputPhrase').innerHTML = 'Show signs to camera';
      document.getElementById('outputSign').innerHTML = '';
      document.getElementById('statusMessage').innerHTML = '‚ö° Waiting for signs...';
    });

    document.getElementById('modeSpeech2Sign').addEventListener('click', function() {
      document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      currentMode = 'speech2sign';
      document.getElementById('modeStatus').innerHTML = 'üé§‚Üí‚úã';
      document.getElementById('outputPhrase').innerHTML = 'Speak now';
      document.getElementById('outputSign').innerHTML = '';
      document.getElementById('statusMessage').innerHTML = '‚ö° Listening...';
    });

    // ========== CAMERA CONTROL ==========
    async function toggleCamera() {
      const btn = document.getElementById('cameraBtn');
      const status = document.getElementById('cameraStatus');
      
      if (!cameraActive) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          videoStream = stream;
          
          // Simple sign simulation for demo
          setInterval(() => {
            if (cameraActive && currentMode === 'sign2speech') {
              const signs = ['hello', 'thank you', 'help', 'how are you'];
              const randomSign = signs[Math.floor(Math.random() * signs.length)];
              const signLang = document.getElementById('signLang').value;
              
              document.getElementById('outputPhrase').innerHTML = randomSign;
              document.getElementById('outputSign').innerHTML = signDatabase[randomSign]?.[signLang] || 'ü´± (sign detected)';
              document.getElementById('liveCaption').innerHTML = `ü§ü ${signDatabase[randomSign]?.[signLang] || randomSign}`;
              document.getElementById('statusMessage').innerHTML = '‚ö° Translating sign to speech...';
            }
          }, 3000);
          
          cameraActive = true;
          btn.classList.add('active');
          btn.innerHTML = 'üì∑ Stop Camera';
          status.innerHTML = '<span class="dot active"></span> On';
          document.getElementById('liveCaption').innerHTML = 'ü§ü Camera active';
          
        } catch (error) {
          logError('Camera error:', error);
        }
      } else {
        if (videoStream) videoStream.getTracks().forEach(t => t.stop());
        cameraActive = false;
        btn.classList.remove('active');
        btn.innerHTML = 'üì∑ Start Camera';
        status.innerHTML = '<span class="dot inactive"></span> Off';
        document.getElementById('liveCaption').innerHTML = 'ü§ü Camera stopped';
      }
    }

    // ========== MICROPHONE CONTROL ==========
    function toggleMicrophone() {
      const btn = document.getElementById('micBtn');
      const status = document.getElementById('micStatus');
      
      if (!micActive) {
        if (!('webkitSpeechRecognition' in window)) {
          alert('Speech recognition not supported');
          return;
        }
        
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = document.getElementById('spokenLang').value === 'sw' ? 'sw-TZ' : 'en-US';
        
        recognition.onstart = () => {
          micActive = true;
          btn.classList.add('active');
          btn.innerHTML = 'üé§ Stop Mic';
          status.innerHTML = '<span class="dot active"></span> On';
          document.getElementById('liveCaption').innerHTML = 'üé§ Listening...';
        };
        
        recognition.onresult = (event) => {
          const transcript = Array.from(event.results)
            .map(r => r[0].transcript)
            .join(' ')
            .toLowerCase()
            .trim();
          
          document.getElementById('outputPhrase').innerHTML = transcript;
          
          // Find matching sign
          let foundSign = null;
          for (const [word, signs] of Object.entries(signDatabase)) {
            if (transcript.includes(word)) {
              const signLang = document.getElementById('signLang').value;
              foundSign = signs[signLang] || signs['ASL'];
              document.getElementById('outputSign').innerHTML = foundSign;
              document.getElementById('liveCaption').innerHTML = `ü§ü ${foundSign}`;
              break;
            }
          }
          
          if (!foundSign) {
            document.getElementById('outputSign').innerHTML = 'ü´± (processing sign)';
          }
          
          document.getElementById('statusMessage').innerHTML = '‚ö° Translating speech to sign...';
        };
        
        recognition.start();
      } else {
        if (recognition) recognition.stop();
        micActive = false;
        btn.classList.remove('active');
        btn.innerHTML = 'üé§ Start Mic';
        status.innerHTML = '<span class="dot inactive"></span> Off';
        document.getElementById('liveCaption').innerHTML = 'ü§ü Microphone stopped';
      }
    }

    // ========== AUTHENTICATION ==========
    let currentAuthMode = 'login';

    document.getElementById('loginBtn').addEventListener('click', () => openAuthModal('login'));
    document.getElementById('signupBtn').addEventListener('click', () => openAuthModal('signup'));
    document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
    document.getElementById('modalCancel').addEventListener('click', closeAuthModal);
    document.getElementById('modalConfirm').addEventListener('click', handleAuth);
    document.getElementById('modalToggle').addEventListener('click', toggleAuthMode);

    function openAuthModal(mode) {
      currentAuthMode = mode;
      document.getElementById('modalTitle').innerText = mode === 'login' ? 'Login' : 'Sign Up';
      document.getElementById('modalToggle').innerText = mode === 'login' ? 
        "Don't have an account? Sign up" : "Already have an account? Login";
      document.getElementById('authModal').style.display = 'flex';
    }

    function closeAuthModal() {
      document.getElementById('authModal').style.display = 'none';
    }

    function toggleAuthMode() {
      openAuthModal(currentAuthMode === 'login' ? 'signup' : 'login');
    }

    async function handleAuth() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      
      if (!email || !password) {
        alert('Please enter email and password');
        return;
      }
      
      try {
        if (currentAuthMode === 'login') {
          await auth.signInWithEmailAndPassword(email, password);
        } else {
          await auth.createUserWithEmailAndPassword(email, password);
        }
        closeAuthModal();
      } catch (error) {
        alert(error.message);
      }
    }

    auth.onAuthStateChanged((user) => {
      currentUser = user;
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const cameraBtn = document.getElementById('cameraBtn');
      const micBtn = document.getElementById('micBtn');
      
      if (user) {
        loginBtn.style.display = 'none';
        signupBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        cameraBtn.disabled = false;
        micBtn.disabled = false;
        showWelcome(user.email);
      } else {
        loginBtn.style.display = 'inline-block';
        signupBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        cameraBtn.disabled = true;
        micBtn.disabled = true;
      }
    });

    // ========== EVENT LISTENERS ==========
    document.getElementById('cameraBtn').addEventListener('click', toggleCamera);
    document.getElementById('micBtn').addEventListener('click', toggleMicrophone);

    // ========== INITIALIZATION ==========
    window.onload = () => {
      init3DAvatar();
      
      // Set initial state
      document.getElementById('liveCaption').innerHTML = 'ü§ü Ready to assist';
      document.getElementById('outputPhrase').innerHTML = 'Ready to communicate';
      document.getElementById('statusMessage').innerHTML = '‚ö° Login to start';
    };

    // ========== RESIZE HANDLER ==========
    window.addEventListener('resize', () => {
      const canvas = document.getElementById('avatarCanvas');
      if (camera3D && renderer) {
        camera3D.aspect = canvas.clientWidth / canvas.clientHeight;
        camera3D.updateProjectionMatrix();
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      }
    });

    // ========== SERVICE WORKER ==========
    if ('serviceWorker' in navigator) {
      // Don't register SW in development environments that block it
      if (!window.location.hostname.includes('deepseeksvc')) {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW optional:', err));
      }
    }
  </script>
</body>
</html>
