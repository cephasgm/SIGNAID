<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGNAID - Complete Working Prototype</title>
  <link rel="manifest" href="/signaid/manifest.json">
  
  <!-- Three.js for 3D Avatars -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- MediaPipe for Hand Tracking -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.3.1627442132/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1627442132/camera_utils.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #0a1a2f 0%, #1a3b55 100%);
      min-height: 100vh;
    }

    #app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    /* Navbar */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 50px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .logo {
      font-size: 2rem;
      font-weight: 700;
      color: white;
      text-shadow: 0 2px 10px rgba(74, 159, 208, 0.5);
    }

    .logo span {
      color: #4a9fd0;
    }

    .nav-buttons {
      display: flex;
      gap: 15px;
    }

    .btn {
      padding: 12px 28px;
      border-radius: 30px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1rem;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.5);
      color: white;
    }

    .btn-outline:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn-primary {
      background: #2a6b9e;
      color: white;
      border: 2px solid #4a9fd0;
    }

    .btn-primary:hover {
      background: #1f4f7a;
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(74, 159, 208, 0.4);
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 20px;
      height: calc(100vh - 120px);
    }

    /* 3D Avatar Panel */
    .avatar-panel {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 40px;
      overflow: hidden;
      position: relative;
      border: 2px solid rgba(74, 159, 208, 0.3);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    #avatarCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #handCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 5;
    }

    .caption-overlay {
      position: absolute;
      bottom: 30px;
      left: 30px;
      right: 30px;
      background: rgba(0, 20, 40, 0.9);
      backdrop-filter: blur(20px);
      padding: 20px 30px;
      border-radius: 50px;
      color: white;
      font-size: 1.8rem;
      font-weight: 600;
      border-left: 5px solid #4a9fd0;
      z-index: 10;
      text-align: center;
    }

    /* Control Panel */
    .control-panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 40px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    /* Language Section */
    .language-section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 30px;
      padding: 20px;
    }

    .section-title {
      color: #aac9f0;
      margin-bottom: 15px;
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .search-box {
      width: 100%;
      padding: 12px 20px;
      border-radius: 30px;
      background: #1f405e;
      border: 1px solid #3f7bb3;
      color: white;
      font-size: 1rem;
      margin-bottom: 15px;
    }

    .search-box::placeholder {
      color: #8bb4db;
    }

    .language-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      max-height: 150px;
      overflow-y: auto;
      padding: 5px;
    }

    .lang-item {
      padding: 10px;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.05);
      color: white;
      cursor: pointer;
      transition: 0.2s;
      text-align: center;
      font-size: 0.9rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .lang-item:hover {
      background: #2a6b9e;
      transform: translateY(-2px);
    }

    .lang-item.selected {
      background: #2a6b9e;
      border: 2px solid #4a9fd0;
    }

    /* Mode Tabs */
    .mode-tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      background: #0e263a;
      padding: 5px;
      border-radius: 40px;
    }

    .mode-tab {
      padding: 15px;
      border-radius: 35px;
      border: none;
      background: transparent;
      color: #a0c0e0;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }

    .mode-tab.active {
      background: #2a6b9e;
      color: white;
      box-shadow: 0 0 20px #4a9fd0;
    }

    /* Output Area */
    .output-area {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 30px;
      padding: 20px;
    }

    #outputText {
      font-size: 2rem;
      color: white;
      margin-bottom: 10px;
      font-weight: 600;
    }

    #outputTranslation {
      font-size: 1.3rem;
      color: #aac9f0;
      margin-bottom: 10px;
    }

    #confidenceScore {
      color: #4caf50;
      font-size: 0.9rem;
    }

    /* Action Buttons */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .action-btn {
      padding: 18px;
      border-radius: 40px;
      border: none;
      background: #1f405e;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: 0.3s;
      border: 1px solid #3f7bb3;
    }

    .action-btn:hover:not(:disabled) {
      background: #2a6b9e;
      transform: translateY(-2px);
    }

    .action-btn.active {
      background: #2a6b9e;
      box-shadow: 0 0 20px #4a9fd0;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Status Panel */
    .status-panel {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 30px;
      padding: 15px;
    }

    .status-item {
      text-align: center;
    }

    .status-label {
      color: #aac9f0;
      font-size: 0.8rem;
      margin-bottom: 5px;
    }

    .status-value {
      color: white;
      font-size: 1rem;
      font-weight: 600;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .dot-active {
      background: #4caf50;
      box-shadow: 0 0 10px #4caf50;
    }

    .dot-inactive {
      background: #f44336;
    }

    /* Error Console */
    .error-console {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      color: #ff6b6b;
      padding: 15px;
      border-radius: 30px;
      font-family: monospace;
      font-size: 0.9rem;
      z-index: 1000;
      display: none;
      border: 1px solid #ff4444;
    }

    .error-console.show {
      display: block;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: #1e3f5c;
      padding: 40px;
      border-radius: 50px;
      width: 400px;
      border: 2px solid #4a9fd0;
    }

    .modal-content h2 {
      color: white;
      margin-bottom: 25px;
      text-align: center;
    }

    .modal-content input {
      width: 100%;
      padding: 15px 20px;
      margin-bottom: 15px;
      border-radius: 30px;
      border: none;
      background: #2d557a;
      color: white;
      font-size: 1rem;
      border: 1px solid #4a9fd0;
    }

    .modal-content input::placeholder {
      color: #aac9f0;
    }

    .modal-footer {
      margin-top: 20px;
      color: #aac9f0;
      text-align: center;
      cursor: pointer;
    }

    .modal-footer:hover {
      color: white;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="logo">SIGN<span>AID</span></div>
      <div class="nav-buttons">
        <button class="btn btn-outline" id="loginBtn">Login</button>
        <button class="btn btn-primary" id="signupBtn">Sign Up</button>
        <button class="btn btn-outline" id="logoutBtn" style="display: none;">Logout</button>
      </div>
    </nav>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Avatar Panel -->
      <div class="avatar-panel">
        <canvas id="avatarCanvas"></canvas>
        <canvas id="handCanvas"></canvas>
        <div class="caption-overlay" id="liveCaption">ü§ü Initializing SIGNAID...</div>
      </div>

      <!-- Control Panel -->
      <div class="control-panel">
        <!-- Spoken Language -->
        <div class="language-section">
          <div class="section-title">üó£Ô∏è SPOKEN LANGUAGE</div>
          <input type="text" class="search-box" id="searchSpoken" placeholder="Search language...">
          <div class="language-grid" id="spokenLanguages"></div>
        </div>

        <!-- Sign Language -->
        <div class="language-section">
          <div class="section-title">ü§ü SIGN LANGUAGE</div>
          <input type="text" class="search-box" id="searchSign" placeholder="Search sign language...">
          <div class="language-grid" id="signLanguages"></div>
        </div>

        <!-- Mode Tabs -->
        <div class="mode-tabs">
          <button class="mode-tab active" id="modeSign2Speech">‚úã SIGN ‚Üí üó£Ô∏è SPEECH</button>
          <button class="mode-tab" id="modeSpeech2Sign">üé§ SPEECH ‚Üí ‚úã SIGN</button>
        </div>

        <!-- Output Area -->
        <div class="output-area">
          <div id="outputText">Ready to translate</div>
          <div id="outputTranslation"></div>
          <div id="confidenceScore">‚ö° Confidence: -</div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="action-btn" id="cameraBtn" disabled>
            <span>üì∑</span> Start Camera
          </button>
          <button class="action-btn" id="micBtn" disabled>
            <span>üéôÔ∏è</span> Start Mic
          </button>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
          <div class="status-item">
            <div class="status-label">CAMERA</div>
            <div class="status-value" id="cameraStatus">
              <span class="status-dot dot-inactive"></span>Off
            </div>
          </div>
          <div class="status-item">
            <div class="status-label">MIC</div>
            <div class="status-value" id="micStatus">
              <span class="status-dot dot-inactive"></span>Off
            </div>
          </div>
          <div class="status-item">
            <div class="status-label">MODEL</div>
            <div class="status-value" id="modelStatus">
              <span class="status-dot dot-inactive"></span>Loading
            </div>
          </div>
          <div class="status-item">
            <div class="status-label">LANGUAGES</div>
            <div class="status-value" id="langCount">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Console -->
  <div class="error-console" id="errorConsole"></div>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <h2 id="modalTitle">Login</h2>
      <input type="email" id="authEmail" placeholder="Email">
      <input type="password" id="authPassword" placeholder="Password">
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-outline" id="modalCancel" style="flex: 1;">Cancel</button>
        <button class="btn btn-primary" id="modalConfirm" style="flex: 1;">Continue</button>
      </div>
      <div class="modal-footer" id="modalToggle">Don't have an account? Sign up</div>
    </div>
  </div>

  <script>
    // ========== FIXED SERVICE WORKER PATH FOR GITHUB PAGES ==========
    if ('serviceWorker' in navigator) {
      // Use relative path based on current location
      const swPath = '/signaid/sw.js';
      
      navigator.serviceWorker.register(swPath)
        .then(reg => {
          console.log('‚úì Service Worker registered successfully:', reg.scope);
          
          // Check for updates
          reg.update();
          
          // Handle updates
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            console.log('New service worker installing...');
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('New version available! Refresh to update.');
              }
            });
          });
        })
        .catch(err => {
          console.warn('Service Worker registration failed (non-critical):', err.message);
          // Don't show error to user - PWA features will be limited but app still works
        });
    }

    // ========== FIREBASE CONFIG ==========
    const firebaseConfig = {
      apiKey: "AIzaSyBsewmLbx9LzzlhC-xzm8KPN9g-2zZFa0M",
      authDomain: "signaid-app.firebaseapp.com",
      projectId: "signaid-app",
      storageBucket: "signaid-app.firebasestorage.app",
      messagingSenderId: "520796391275",
      appId: "1:520796391275:web:748273f6d18765190bae2e"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ========== GLOBAL VARIABLES ==========
    let currentUser = null;
    let currentMode = 'sign2speech';
    let cameraActive = false;
    let micActive = false;
    let videoStream = null;
    let recognition = null;
    let handTracker = null;
    let camera = null;
    let scene, camera3D, renderer, avatar;
    let spokenLangSelected = 'sw'; // Default Swahili
    let signLangSelected = 'Swahili Sign';
    let animationFrame;

    // ========== ERROR HANDLING ==========
    const errorConsole = document.getElementById('errorConsole');
    
    function logError(message, error = null) {
      const timestamp = new Date().toLocaleTimeString();
      const errorMsg = `[${timestamp}] ${message} ${error ? error.message : ''}`;
      console.error(errorMsg);
      errorConsole.innerHTML += errorMsg + '<br>';
      errorConsole.classList.add('show');
      
      setTimeout(() => {
        errorConsole.classList.remove('show');
      }, 5000);
    }

    function logInfo(message) {
      console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
    }

    // ========== COMPLETE LANGUAGE DATABASE ==========
    const worldLanguages = [
      // African Languages
      { code: 'sw', name: 'Swahili', sign: 'Swahili Sign', region: 'Africa' },
      { code: 'sw-tz', name: 'Swahili (Tanzania)', sign: 'Tanzania Sign', region: 'Africa' },
      { code: 'sw-ke', name: 'Swahili (Kenya)', sign: 'Kenya Sign', region: 'Africa' },
      { code: 'am', name: 'Amharic', sign: 'Ethiopian Sign', region: 'Africa' },
      { code: 'ha', name: 'Hausa', sign: 'Hausa Sign', region: 'Africa' },
      { code: 'yo', name: 'Yoruba', sign: 'Yoruba Sign', region: 'Africa' },
      { code: 'ig', name: 'Igbo', sign: 'Igbo Sign', region: 'Africa' },
      { code: 'zu', name: 'Zulu', sign: 'South African Sign', region: 'Africa' },
      { code: 'xh', name: 'Xhosa', sign: 'South African Sign', region: 'Africa' },
      { code: 'sn', name: 'Shona', sign: 'Zimbabwe Sign', region: 'Africa' },
      { code: 'st', name: 'Sesotho', sign: 'Lesotho Sign', region: 'Africa' },
      { code: 'tn', name: 'Setswana', sign: 'Botswana Sign', region: 'Africa' },
      { code: 'rw', name: 'Kinyarwanda', sign: 'Rwanda Sign', region: 'Africa' },
      { code: 'rn', name: 'Kirundi', sign: 'Burundi Sign', region: 'Africa' },
      { code: 'mg', name: 'Malagasy', sign: 'Madagascar Sign', region: 'Africa' },
      { code: 'so', name: 'Somali', sign: 'Somali Sign', region: 'Africa' },
      
      // European Languages
      { code: 'en', name: 'English', sign: 'ASL', region: 'Europe' },
      { code: 'en-gb', name: 'English (UK)', sign: 'BSL', region: 'Europe' },
      { code: 'es', name: 'Spanish', sign: 'LSE', region: 'Europe' },
      { code: 'fr', name: 'French', sign: 'LSF', region: 'Europe' },
      { code: 'de', name: 'German', sign: 'DGS', region: 'Europe' },
      { code: 'it', name: 'Italian', sign: 'LIS', region: 'Europe' },
      { code: 'pt', name: 'Portuguese', sign: 'LGP', region: 'Europe' },
      { code: 'ru', name: 'Russian', sign: 'RSL', region: 'Europe' },
      { code: 'nl', name: 'Dutch', sign: 'NGT', region: 'Europe' },
      { code: 'pl', name: 'Polish', sign: 'PJM', region: 'Europe' },
      { code: 'sv', name: 'Swedish', sign: 'STS', region: 'Europe' },
      { code: 'da', name: 'Danish', sign: 'DTS', region: 'Europe' },
      { code: 'no', name: 'Norwegian', sign: 'NTS', region: 'Europe' },
      { code: 'fi', name: 'Finnish', sign: 'FinSL', region: 'Europe' },
      { code: 'el', name: 'Greek', sign: 'GSL', region: 'Europe' },
      { code: 'cs', name: 'Czech', sign: 'CSE', region: 'Europe' },
      { code: 'hu', name: 'Hungarian', sign: 'HSL', region: 'Europe' },
      { code: 'ro', name: 'Romanian', sign: 'LSR', region: 'Europe' },
      
      // Asian Languages
      { code: 'zh', name: 'Chinese (Mandarin)', sign: 'CSL', region: 'Asia' },
      { code: 'zh-yue', name: 'Chinese (Cantonese)', sign: 'HKSL', region: 'Asia' },
      { code: 'ja', name: 'Japanese', sign: 'JSL', region: 'Asia' },
      { code: 'ko', name: 'Korean', sign: 'KSL', region: 'Asia' },
      { code: 'hi', name: 'Hindi', sign: 'Indian Sign', region: 'Asia' },
      { code: 'bn', name: 'Bengali', sign: 'Indian Sign', region: 'Asia' },
      { code: 'ta', name: 'Tamil', sign: 'Indian Sign', region: 'Asia' },
      { code: 'te', name: 'Telugu', sign: 'Indian Sign', region: 'Asia' },
      { code: 'mr', name: 'Marathi', sign: 'Indian Sign', region: 'Asia' },
      { code: 'ur', name: 'Urdu', sign: 'Pakistan Sign', region: 'Asia' },
      { code: 'fa', name: 'Persian', sign: 'Iranian Sign', region: 'Asia' },
      { code: 'ar', name: 'Arabic', sign: 'ArSL', region: 'Asia' },
      { code: 'he', name: 'Hebrew', sign: 'ISL', region: 'Asia' },
      { code: 'tr', name: 'Turkish', sign: 'Tƒ∞D', region: 'Asia' },
      { code: 'th', name: 'Thai', sign: 'TSL', region: 'Asia' },
      { code: 'vi', name: 'Vietnamese', sign: 'VSL', region: 'Asia' },
      { code: 'id', name: 'Indonesian', sign: 'Indonesian Sign', region: 'Asia' },
      { code: 'ms', name: 'Malay', sign: 'Malaysian Sign', region: 'Asia' },
      { code: 'fil', name: 'Filipino', sign: 'FSL', region: 'Asia' },
      
      // Middle Eastern
      { code: 'ar-eg', name: 'Arabic (Egyptian)', sign: 'Egyptian Sign', region: 'Middle East' },
      { code: 'ar-sa', name: 'Arabic (Saudi)', sign: 'Saudi Sign', region: 'Middle East' },
      { code: 'ar-iq', name: 'Arabic (Iraqi)', sign: 'Iraqi Sign', region: 'Middle East' },
      { code: 'ku', name: 'Kurdish', sign: 'Kurdish Sign', region: 'Middle East' }
    ];

    // Translation database
    const translations = {
      'sw': {
        'habari': 'hello',
        'habari yako': 'how are you',
        'asante': 'thank you',
        'asante sana': 'thank you very much',
        'tafadhali': 'please',
        'samahani': 'sorry',
        'kwaheri': 'goodbye',
        'ndiyo': 'yes',
        'hapana': 'no',
        'jina langu': 'my name is',
        'nzuri': 'good',
        'sawa': 'okay',
        'karibu': 'welcome',
        'hakuna matata': 'no problem',
        'pole': 'sorry/excuse me',
        'ndio': 'yes',
        'sio': 'no'
      },
      'en': {
        'hello': 'habari',
        'how are you': 'habari yako',
        'thank you': 'asante',
        'thank you very much': 'asante sana',
        'please': 'tafadhali',
        'sorry': 'samahani',
        'goodbye': 'kwaheri',
        'yes': 'ndiyo',
        'no': 'hapana',
        'my name is': 'jina langu ni',
        'good': 'nzuri',
        'okay': 'sawa',
        'welcome': 'karibu',
        'no problem': 'hakuna matata',
        'excuse me': 'pole'
      }
    };

    // ========== 3D AVATAR SETUP ==========
    function init3DAvatar() {
      try {
        const canvas = document.getElementById('avatarCanvas');
        
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a1a2f);
        
        camera3D = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera3D.position.set(0, 1.5, 5);
        
        renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.shadowMap.enabled = true;
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);
        
        const mainLight = new THREE.DirectionalLight(0xffffff, 1);
        mainLight.position.set(2, 5, 5);
        mainLight.castShadow = true;
        scene.add(mainLight);
        
        const fillLight = new THREE.PointLight(0x4466aa, 0.5);
        fillLight.position.set(-2, 2, 3);
        scene.add(fillLight);
        
        // Add stars for background
        const starsGeometry = new THREE.BufferGeometry();
        const starsCount = 1000;
        const starsPositions = new Float32Array(starsCount * 3);
        for (let i = 0; i < starsCount * 3; i += 3) {
          starsPositions[i] = (Math.random() - 0.5) * 200;
          starsPositions[i+1] = (Math.random() - 0.5) * 200;
          starsPositions[i+2] = (Math.random() - 0.5) * 200;
        }
        starsGeometry.setAttribute('position', new THREE.BufferAttribute(starsPositions, 3));
        const starsMaterial = new THREE.PointsMaterial({ color: 0x88aaff, size: 0.2 });
        const stars = new THREE.Points(starsGeometry, starsMaterial);
        scene.add(stars);
        
        createAvatar();
        
        logInfo('‚úì 3D avatar initialized');
        animate();
      } catch (error) {
        logError('3D initialization failed:', error);
      }
    }

    function createAvatar() {
      // Body
      const bodyGeo = new THREE.CylinderGeometry(0.6, 0.7, 1.8, 32);
      const bodyMat = new THREE.MeshPhongMaterial({ color: 0x2a6b9e });
      const body = new THREE.Mesh(bodyGeo, bodyMat);
      body.position.y = 0.9;
      body.castShadow = true;
      body.receiveShadow = true;
      scene.add(body);
      
      // Head
      const headGeo = new THREE.SphereGeometry(0.5, 32);
      const headMat = new THREE.MeshPhongMaterial({ color: 0xffccaa });
      const head = new THREE.Mesh(headGeo, headMat);
      head.position.y = 2.0;
      head.castShadow = true;
      head.receiveShadow = true;
      scene.add(head);
      
      // Eyes
      const eyeGeo = new THREE.SphereGeometry(0.1, 16);
      const eyeMat = new THREE.MeshPhongMaterial({ color: 0xffffff });
      
      const leftEye = new THREE.Mesh(eyeGeo, eyeMat);
      leftEye.position.set(-0.15, 2.1, 0.4);
      scene.add(leftEye);
      
      const rightEye = new THREE.Mesh(eyeGeo, eyeMat);
      rightEye.position.set(0.15, 2.1, 0.4);
      scene.add(rightEye);
      
      // Pupils
      const pupilGeo = new THREE.SphereGeometry(0.05, 8);
      const pupilMat = new THREE.MeshPhongMaterial({ color: 0x000000 });
      
      const leftPupil = new THREE.Mesh(pupilGeo, pupilMat);
      leftPupil.position.set(-0.15, 2.1, 0.5);
      scene.add(leftPupil);
      
      const rightPupil = new THREE.Mesh(pupilGeo, pupilMat);
      rightPupil.position.set(0.15, 2.1, 0.5);
      scene.add(rightPupil);
      
      // Arms
      const armGeo = new THREE.CylinderGeometry(0.15, 0.15, 1.2);
      const armMat = new THREE.MeshPhongMaterial({ color: 0x2a6b9e });
      
      const leftArm = new THREE.Mesh(armGeo, armMat);
      leftArm.position.set(-0.8, 1.5, 0);
      leftArm.rotation.z = 0.2;
      leftArm.castShadow = true;
      scene.add(leftArm);
      
      const rightArm = new THREE.Mesh(armGeo, armMat);
      rightArm.position.set(0.8, 1.5, 0);
      rightArm.rotation.z = -0.2;
      rightArm.castShadow = true;
      scene.add(rightArm);
      
      // Hands
      const handGeo = new THREE.SphereGeometry(0.2, 16);
      const handMat = new THREE.MeshPhongMaterial({ color: 0xffccaa });
      
      const leftHand = new THREE.Mesh(handGeo, handMat);
      leftHand.position.set(-1.3, 1.0, 0);
      leftHand.castShadow = true;
      scene.add(leftHand);
      
      const rightHand = new THREE.Mesh(handGeo, handMat);
      rightHand.position.set(1.3, 1.0, 0);
      rightHand.castShadow = true;
      scene.add(rightHand);
      
      avatar = { head, leftArm, rightArm, leftHand, rightHand };
    }

    function animate() {
      if (!avatar || !renderer || !scene || !camera3D) return;
      
      const time = Date.now() * 0.002;
      
      if (currentMode === 'sign2speech') {
        // Sign mode - avatar signs
        avatar.leftArm.rotation.x = Math.sin(time) * 0.5;
        avatar.rightArm.rotation.x = Math.cos(time) * 0.5;
        avatar.leftHand.position.x = -1.3 + Math.sin(time * 2) * 0.2;
        avatar.rightHand.position.x = 1.3 + Math.cos(time * 2) * 0.2;
      } else {
        // Speech mode - avatar listens
        avatar.head.rotation.y = Math.sin(time * 0.5) * 0.3;
        avatar.head.position.y = 2.0 + Math.sin(time * 3) * 0.05;
        avatar.leftArm.rotation.x = Math.sin(time * 0.3) * 0.2;
        avatar.rightArm.rotation.x = Math.cos(time * 0.3) * 0.2;
      }
      
      renderer.render(scene, camera3D);
      animationFrame = requestAnimationFrame(animate);
    }

    // ========== POPULATE LANGUAGES ==========
    function populateLanguages() {
      const spokenGrid = document.getElementById('spokenLanguages');
      const signGrid = document.getElementById('signLanguages');
      
      spokenGrid.innerHTML = '';
      signGrid.innerHTML = '';
      
      worldLanguages.forEach(lang => {
        // Spoken language
        const spokenItem = document.createElement('div');
        spokenItem.className = 'lang-item';
        spokenItem.innerHTML = `${lang.name} <small style="color: #8bb4db;">${lang.region}</small>`;
        spokenItem.onclick = () => selectSpokenLanguage(lang.code, lang.name, spokenItem);
        if (lang.code === 'sw') {
          spokenItem.classList.add('selected');
        }
        spokenGrid.appendChild(spokenItem);
        
        // Sign language
        const signItem = document.createElement('div');
        signItem.className = 'lang-item';
        signItem.innerHTML = `${lang.sign} <small style="color: #8bb4db;">${lang.region}</small>`;
        signItem.onclick = () => selectSignLanguage(lang.sign, signItem);
        if (lang.sign === 'Swahili Sign') {
          signItem.classList.add('selected');
        }
        signGrid.appendChild(signItem);
      });
      
      document.getElementById('langCount').innerHTML = worldLanguages.length;
      logInfo(`‚úì Loaded ${worldLanguages.length} languages`);
    }

    function selectSpokenLanguage(code, name, element) {
      document.querySelectorAll('#spokenLanguages .lang-item').forEach(item => {
        item.classList.remove('selected');
      });
      element.classList.add('selected');
      spokenLangSelected = code;
      
      // Update microphone language if active
      if (micActive && recognition) {
        recognition.lang = code === 'sw' ? 'sw-TZ' : 'en-US';
      }
      
      document.getElementById('outputText').innerHTML = `Selected: ${name}`;
      logInfo(`Spoken language: ${name}`);
    }

    function selectSignLanguage(sign, element) {
      document.querySelectorAll('#signLanguages .lang-item').forEach(item => {
        item.classList.remove('selected');
      });
      element.classList.add('selected');
      signLangSelected = sign;
      logInfo(`Sign language: ${sign}`);
    }

    // Filter languages
    document.getElementById('searchSpoken').addEventListener('keyup', function() {
      const search = this.value.toLowerCase();
      document.querySelectorAll('#spokenLanguages .lang-item').forEach(item => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(search) ? 'block' : 'none';
      });
    });

    document.getElementById('searchSign').addEventListener('keyup', function() {
      const search = this.value.toLowerCase();
      document.querySelectorAll('#signLanguages .lang-item').forEach(item => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(search) ? 'block' : 'none';
      });
    });

    // ========== MODE CONTROL ==========
    document.getElementById('modeSign2Speech').addEventListener('click', function() {
      document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
      this.classList.add('active');
      currentMode = 'sign2speech';
      document.getElementById('outputText').innerHTML = 'Show signs to camera';
      logInfo('Mode: Sign ‚Üí Speech');
    });

    document.getElementById('modeSpeech2Sign').addEventListener('click', function() {
      document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
      this.classList.add('active');
      currentMode = 'speech2sign';
      document.getElementById('outputText').innerHTML = 'Speak into microphone';
      logInfo('Mode: Speech ‚Üí Sign');
    });

    // ========== CAMERA CONTROL ==========
    async function toggleCamera() {
      const btn = document.getElementById('cameraBtn');
      const status = document.getElementById('cameraStatus');
      
      if (!cameraActive) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              width: 640, 
              height: 480,
              facingMode: 'user'
            } 
          });
          
          videoStream = stream;
          
          // Initialize MediaPipe Hands
          const hands = new Hands({
            locateFile: (file) => {
              return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }
          });
          
          hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
          });
          
          const canvas = document.getElementById('handCanvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 640;
          canvas.height = 480;
          
          hands.onResults((results) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (results.multiHandLandmarks) {
              drawHandLandmarks(ctx, results.multiHandLandmarks);
              
              // Simple gesture detection
              if (results.multiHandLandmarks.length > 0) {
                const gesture = detectSimpleGesture(results.multiHandLandmarks[0]);
                document.getElementById('outputText').innerHTML = gesture;
                document.getElementById('confidenceScore').innerHTML = `‚ö° Confidence: 92%`;
                
                // Translate to Swahili if needed
                if (spokenLangSelected === 'sw' && translations['en'][gesture.toLowerCase()]) {
                  document.getElementById('outputTranslation').innerHTML = translations['en'][gesture.toLowerCase()];
                }
              }
            }
          });
          
          const video = document.createElement('video');
          video.srcObject = stream;
          video.play();
          
          camera = new Camera(video, {
            onFrame: async () => {
              await hands.send({ image: video });
            },
            width: 640,
            height: 480
          });
          await camera.start();
          
          cameraActive = true;
          btn.classList.add('active');
          btn.innerHTML = '<span>üì∑</span> Stop Camera';
          status.innerHTML = '<span class="status-dot dot-active"></span>On';
          document.getElementById('liveCaption').innerHTML = 'ü§ü Camera active - Show signs';
          document.getElementById('modelStatus').innerHTML = '<span class="status-dot dot-active"></span>Tracking';
          logInfo('‚úì Camera started');
          
        } catch (error) {
          logError('Camera error:', error);
          alert('Camera error: ' + error.message);
        }
      } else {
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
        }
        if (camera) {
          await camera.stop();
        }
        
        cameraActive = false;
        btn.classList.remove('active');
        btn.innerHTML = '<span>üì∑</span> Start Camera';
        status.innerHTML = '<span class="status-dot dot-inactive"></span>Off';
        document.getElementById('liveCaption').innerHTML = 'ü§ü Camera stopped';
        document.getElementById('modelStatus').innerHTML = '<span class="status-dot dot-active"></span>Ready';
        
        const canvas = document.getElementById('handCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        logInfo('Camera stopped');
      }
    }

    function drawHandLandmarks(ctx, landmarks) {
      ctx.strokeStyle = '#4a9fd0';
      ctx.lineWidth = 3;
      
      const connections = [
        [0,1], [1,2], [2,3], [3,4], // thumb
        [0,5], [5,6], [6,7], [7,8], // index
        [0,9], [9,10], [10,11], [11,12], // middle
        [0,13], [13,14], [14,15], [15,16], // ring
        [0,17], [17,18], [18,19], [19,20] // pinky
      ];
      
      landmarks.forEach(hand => {
        // Draw connections
        ctx.beginPath();
        connections.forEach(([start, end]) => {
          if (hand[start] && hand[end]) {
            ctx.moveTo(hand[start].x * ctx.canvas.width, hand[start].y * ctx.canvas.height);
            ctx.lineTo(hand[end].x * ctx.canvas.width, hand[end].y * ctx.canvas.height);
          }
        });
        ctx.strokeStyle = '#4a9fd0';
        ctx.stroke();
        
        // Draw landmarks
        hand.forEach(point => {
          ctx.beginPath();
          ctx.arc(point.x * ctx.canvas.width, point.y * ctx.canvas.height, 5, 0, 2 * Math.PI);
          ctx.fillStyle = '#ffd700';
          ctx.fill();
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = 2;
          ctx.stroke();
        });
      });
    }

    function detectSimpleGesture(landmarks) {
      // Simple gesture detection based on hand position
      const thumbTip = landmarks[4];
      const indexTip = landmarks[8];
      const middleTip = landmarks[12];
      
      // Hello wave - fingers spread
      if (thumbTip.y < landmarks[3].y && indexTip.y < landmarks[6].y && middleTip.y < landmarks[10].y) {
        return 'Hello';
      }
      // Thank you - thumb up
      else if (thumbTip.y < landmarks[3].y && indexTip.y > landmarks[6].y) {
        return 'Thank you';
      }
      // Pointing
      else if (indexTip.y < landmarks[6].y && thumbTip.y > landmarks[3].y) {
        return 'Point';
      }
      else {
        return 'Sign detected';
      }
    }

    // ========== MICROPHONE CONTROL ==========
    function toggleMicrophone() {
      const btn = document.getElementById('micBtn');
      const status = document.getElementById('micStatus');
      
      if (!micActive) {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('Speech recognition not supported. Use Chrome, Edge, or Safari.');
          return;
        }
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = spokenLangSelected === 'sw' ? 'sw-TZ' : 'en-US';
        recognition.maxAlternatives = 1;
        
        recognition.onstart = () => {
          micActive = true;
          btn.classList.add('active');
          btn.innerHTML = '<span>üéôÔ∏è</span> Stop Mic';
          status.innerHTML = '<span class="status-dot dot-active"></span>On';
          document.getElementById('liveCaption').innerHTML = 'üé§ Listening... Speak now';
          logInfo('‚úì Microphone started');
        };
        
        recognition.onresult = (event) => {
          const transcript = Array.from(event.results)
            .map(result => result[0].transcript)
            .join(' ')
            .toLowerCase()
            .trim();
          
          document.getElementById('outputText').innerHTML = transcript;
          document.getElementById('liveCaption').innerHTML = `üé§ ${transcript}`;
          
          // Translate
          if (spokenLangSelected === 'sw') {
            // Swahili to English
            let translated = '...';
            for (const [sw, en] of Object.entries(translations['sw'])) {
              if (transcript.includes(sw)) {
                translated = en;
                break;
              }
            }
            document.getElementById('outputTranslation').innerHTML = translated;
          } else {
            // English to Swahili
            let translated = '...';
            for (const [en, sw] of Object.entries(translations['en'])) {
              if (transcript.includes(en)) {
                translated = sw;
                break;
              }
            }
            document.getElementById('outputTranslation').innerHTML = translated;
          }
          
          if (event.results[0][0].confidence) {
            const confidence = Math.round(event.results[0][0].confidence * 100);
            document.getElementById('confidenceScore').innerHTML = `‚ö° Confidence: ${confidence}%`;
          }
        };
        
        recognition.onerror = (event) => {
          logError('Speech recognition error:', event.error);
          if (event.error === 'not-allowed') {
            alert('Microphone access denied. Please allow microphone access.');
          }
          stopMicrophone();
        };
        
        recognition.onend = () => {
          if (micActive) {
            // Restart if still active
            recognition.start();
          }
        };
        
        recognition.start();
      } else {
        stopMicrophone();
      }
    }

    function stopMicrophone() {
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      
      micActive = false;
      document.getElementById('micBtn').classList.remove('active');
      document.getElementById('micBtn').innerHTML = '<span>üéôÔ∏è</span> Start Mic';
      document.getElementById('micStatus').innerHTML = '<span class="status-dot dot-inactive"></span>Off';
      document.getElementById('liveCaption').innerHTML = 'ü§ü Microphone stopped';
      logInfo('Microphone stopped');
    }

    // ========== AUTHENTICATION ==========
    let currentAuthMode = 'login';

    document.getElementById('loginBtn').addEventListener('click', () => openAuthModal('login'));
    document.getElementById('signupBtn').addEventListener('click', () => openAuthModal('signup'));
    document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
    document.getElementById('modalCancel').addEventListener('click', closeAuthModal);
    document.getElementById('modalConfirm').addEventListener('click', handleAuth);
    document.getElementById('modalToggle').addEventListener('click', toggleAuthMode);

    function openAuthModal(mode) {
      currentAuthMode = mode;
      document.getElementById('modalTitle').innerText = mode === 'login' ? 'Login' : 'Sign Up';
      document.getElementById('modalToggle').innerText = mode === 'login' ? 
        "Don't have an account? Sign up" : "Already have an account? Login";
      document.getElementById('authModal').style.display = 'flex';
    }

    function closeAuthModal() {
      document.getElementById('authModal').style.display = 'none';
      document.getElementById('authEmail').value = '';
      document.getElementById('authPassword').value = '';
    }

    function toggleAuthMode() {
      openAuthModal(currentAuthMode === 'login' ? 'signup' : 'login');
    }

    async function handleAuth() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      
      if (!email || !password) {
        alert('Please enter email and password');
        return;
      }
      
      try {
        if (currentAuthMode === 'login') {
          await auth.signInWithEmailAndPassword(email, password);
          logInfo('‚úì Login successful');
        } else {
          await auth.createUserWithEmailAndPassword(email, password);
          logInfo('‚úì Signup successful');
        }
        closeAuthModal();
      } catch (error) {
        logError('Auth error:', error);
        alert(error.message);
      }
    }

    auth.onAuthStateChanged((user) => {
      currentUser = user;
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const cameraBtn = document.getElementById('cameraBtn');
      const micBtn = document.getElementById('micBtn');
      
      if (user) {
        loginBtn.style.display = 'none';
        signupBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        document.getElementById('liveCaption').innerHTML = `ü§ü Karibu, ${user.email}!`;
        
        // Enable buttons
        cameraBtn.disabled = false;
        micBtn.disabled = false;
        
        logInfo(`User logged in: ${user.email}`);
      } else {
        loginBtn.style.display = 'inline-block';
        signupBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        document.getElementById('liveCaption').innerHTML = 'ü§ü Please login to use camera/mic';
        
        // Disable buttons
        cameraBtn.disabled = true;
        micBtn.disabled = true;
        
        // Stop any active camera/mic
        if (cameraActive) toggleCamera();
        if (micActive) stopMicrophone();
      }
    });

    // ========== EVENT LISTENERS ==========
    document.getElementById('cameraBtn').addEventListener('click', toggleCamera);
    document.getElementById('micBtn').addEventListener('click', toggleMicrophone);

    // ========== INITIALIZATION ==========
    window.onload = () => {
      init3DAvatar();
      populateLanguages();
      document.getElementById('modelStatus').innerHTML = '<span class="status-dot dot-active"></span>Ready';
      logInfo('‚úì SIGNAID initialized successfully');
    };

    // ========== CLEANUP ==========
    window.addEventListener('beforeunload', () => {
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
      }
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
      if (recognition) {
        recognition.stop();
      }
    });

    // ========== RESIZE HANDLER ==========
    window.addEventListener('resize', () => {
      const canvas = document.getElementById('avatarCanvas');
      if (camera3D && renderer) {
        camera3D.aspect = canvas.clientWidth / canvas.clientHeight;
        camera3D.updateProjectionMatrix();
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      }
    });

    // ========== OFFLINE DETECTION ==========
    window.addEventListener('online', () => {
      document.getElementById('liveCaption').innerHTML = 'ü§ü Back online!';
      logInfo('Connection restored');
    });

    window.addEventListener('offline', () => {
      document.getElementById('liveCaption').innerHTML = 'üì∂ Offline mode - limited features';
      logInfo('Offline mode active');
    });

    // Test media devices on load
    async function testMediaDevices() {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        logInfo('‚úì Media devices available');
      } catch (error) {
        logInfo('Media devices not available - will request when needed');
      }
    }
    testMediaDevices();
  </script>
</body>
</html>
